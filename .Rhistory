pkgs <- c("httr","jsonlite","dplyr","tidyr","lubridate","ggplot2","ggpubr","corrplot","broom")
install_if_missing <- function(p) {
if (!requireNamespace(p, quietly = TRUE)) install.packages(p)
}
invisible(sapply(pkgs, install_if_missing))
source("01_fetch_data.R")
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(tidyr)
city <- "Delhi"
country <- "IN"
days <- 7
today <- Sys.Date()
start_date <- today - days
url_air <- paste0(
"https://api.openaq.org/v2/measurements?",
"country=", country,
"&city=", city,
"&date_from=", start_date,
"&date_to=", today,
"&limit=1000"
)
response_air <- GET(url_air)
data_air_raw <- content(response_air, "text", encoding = "UTF-8")
data_air_json <- fromJSON(data_air_raw, flatten = TRUE)
air_data <- data_air_json$results %>%
select(datetime = date.utc, location, parameter, value, unit) %>%
mutate(datetime = ymd_hms(datetime))
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
url_air <- "https://api.openaq.org/v2/measurements?country=IN&city=Delhi&limit=5"
response_air <- httr::GET(url_air)
jsonlite::fromJSON(httr::content(response_air, "text", encoding = "UTF-8"))
cat("\nScript completed successfully ðŸŽ‰\n")
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(tidyr)
city <- "Delhi"
country <- "IN"
days <- 7
today <- Sys.Date()
start_date <- today - days
cat("Fetching air quality data from OpenAQ v3...\n")
# OpenAQ v3 endpoint
url_air <- paste0(
"https://api.openaq.org/v3/measurements?",
"country_id=", country,
"&city=", city,
"&date_from=", start_date,
"&date_to=", today,
"&limit=1000"
)
response_air <- GET(url_air)
data_air_raw <- content(response_air, "text", encoding = "UTF-8")
data_air_json <- fromJSON(data_air_raw, flatten = TRUE)
if (is.null(data_air_json$results) || nrow(data_air_json$results) == 0) {
stop("âŒ No air quality data returned. Try another city or date range.")
}
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(tidyr)
city <- "London"
country <- "GB"
days <- 7
today <- Sys.Date()
start_date <- today - days
cat("Fetching air quality data from OpenAQ v3...\n")
url_air <- paste0(
"https://api.openaq.org/v3/measurements?",
"country_id=", country,
"&city=", city,
"&date_from=", start_date,
"&date_to=", today,
"&limit=1000"
)
response_air <- GET(url_air)
data_air_raw <- content(response_air, "text", encoding = "UTF-8")
data_air_json <- fromJSON(data_air_raw, flatten = TRUE)
if (is.null(data_air_json$results) || nrow(data_air_json$results) == 0) {
stop("âŒ No air quality data returned. Try another city or date range.")
}
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(tidyr)
city <- "London"
latitude <- 51.5074
longitude <- -0.1278
days <- 7
today <- Sys.Date()
start_date <- today - days
cat("Fetching air quality data from OpenAQ v3 (by coordinates)...\n")
url_air <- paste0(
"https://api.openaq.org/v3/measurements?",
"coordinates=", latitude, ",", longitude,
"&radius=10000",                # within 10 km of London center
"&date_from=", start_date,
"&date_to=", today,
"&limit=1000"
)
response_air <- GET(url_air)
data_air_raw <- content(response_air, "text", encoding = "UTF-8")
data_air_json <- fromJSON(data_air_raw, flatten = TRUE)
if (is.null(data_air_json$results) || nrow(data_air_json$results) == 0) {
stop("âŒ No air quality data found near London in the given date range.")
}
cat("\nScript completed successfully ðŸŽ‰\n")
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
install.packages(c("httr", "jsonlite", "dplyr", "lubridate", "tidyr"))
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(tidyr)
city <- "London"
latitude <- 51.5074
longitude <- -0.1278
days <- 7
today <- Sys.Date()
start_date <- today - days
cat("Fetching air quality data from OpenAQ v3 (by coordinates)...\n")
url_air <- paste0(
"https://api.openaq.org/v3/measurements?",
"coordinates=", latitude, ",", longitude,
"&radius=10000",                # within 10 km of London center
"&date_from=", start_date,
"&date_to=", today,
"&limit=1000"
)
response_air <- GET(url_air)
data_air_raw <- content(response_air, "text", encoding = "UTF-8")
data_air_json <- fromJSON(data_air_raw, flatten = TRUE)
if (is.null(data_air_json$results) || nrow(data_air_json$results) == 0) {
stop("âŒ No air quality data found near London in the given date range.")
}
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(tidyr)
cat("Fetching air quality data for London from DEFRA...\n")
# Step 1: Fetch site metadata from DEFRA
url_sites <- "https://uk-air.defra.gov.uk/data_files/site_data_index.json"
response_sites <- GET(url_sites)
sites_data <- fromJSON(content(response_sites, "text", encoding = "UTF-8"))
library(httr)
library(httr)
library(readr)
library(dplyr)
library(lubridate)
library(jsonlite)
cat("Fetching air quality data for London (DEFRA Marylebone Road)...\n")
# DEFRA publishes hourly CSV data by site; weâ€™ll use London Marylebone Road (code: MY1)
url_air <- "https://uk-air.defra.gov.uk/data_files/site_data/MY1_latest.csv"
# Download and read the CSV
temp_file <- tempfile(fileext = ".csv")
GET(url_air, write_disk(temp_file, overwrite = TRUE))
air_df <- read_csv(temp_file, show_col_types = FALSE)
# Basic clean-up
air_df <- air_df %>%
rename(datetime = `Date Time`) %>%
mutate(datetime = dmy_hms(datetime))
rlang::last_trace()
library(httr)
library(readr)
library(dplyr)
library(lubridate)
library(jsonlite)
cat("Fetching air quality data for London (Marylebone Road)...\n")
# The DEFRA Air Quality Archive provides CSV downloads by site and date
base_url <- "https://uk-air.defra.gov.uk/openair/R_data"
site <- "MY1"  # London Marylebone Road
year <- format(Sys.Date(), "%Y")
url_air <- paste0(base_url, "/", site, "_", year, ".csv")
# Download and read data
temp_file <- tempfile(fileext = ".csv")
response <- GET(url_air)
if (response$status_code != 200) {
stop("âŒ Could not download DEFRA air quality data. Check site or year availability.")
}
library(httr)
library(readr)
library(dplyr)
library(lubridate)
library(jsonlite)
cat("ðŸ” Fetching air quality data for London (Marylebone Road)...\n")
base_url <- "https://uk-air.defra.gov.uk/openair/R_data"
site <- "MY1"  # London Marylebone Road site code
years <- c(2025, 2024, 2023)  # fallback years
air_df <- NULL
for (year in years) {
url_air <- paste0(base_url, "/", site, "_", year, ".csv")
cat("Trying year:", year, "\n")
response <- GET(url_air)
if (response$status_code == 200) {
cat("âœ… Found available data for", year, "\n")
temp_file <- tempfile(fileext = ".csv")
writeBin(content(response, "raw"), temp_file)
air_df <- read_csv(temp_file, show_col_types = FALSE)
break
}
}
if (is.null(air_df)) stop("âŒ Could not download DEFRA air quality data for any available year.")
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(readr)
cat("ðŸ” Fetching air quality data for London (OpenAQ API)...\n")
# OpenAQ API for London
url_air <- "https://api.openaq.org/v3/measurements?city=London&limit=10000"
response <- GET(url_air)
if (response$status_code != 200) {
stop("âŒ Failed to fetch air quality data. HTTP code: ", response$status_code)
}
library(httr)
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(readr)
cat("ðŸ” Fetching air quality data for London (OpenAQ v3 API)...\n")
# OpenAQ v3 API (UK -> GB)
url_air <- "https://api.openaq.org/v3/measurements?country_id=GB&city=London&limit=1000"
response <- GET(url_air, add_headers(Accept = "application/json"))
if (response$status_code != 200) {
stop("âŒ Failed to fetch air quality data. HTTP code: ", response$status_code)
}
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(readr)
cat("ðŸ” Fetching air quality data for London (OpenAQ v3 API)...\n")
# OpenAQ v3 API (UK -> GB)
url_air <- "https://api.openaq.org/v3/measurements?country_id=GB&city=London&parameter=pm25&date_from=2025-11-01&limit=1000"
response <- GET(url_air, add_headers(Accept = "application/json"))
if (response$status_code != 200) {
stop("âŒ Failed to fetch air quality data. HTTP code: ", response$status_code)
}
library(httr)
library(jsonlite)
library(dplyr)
library(lubridate)
library(readr)
cat("ðŸ” Fetching air quality data for London (OpenAQ v3 API)...\n")
# OpenAQ v3 API (UK -> GB)
url_air <- "https://api.openaq.org/v3/measurements?country_id=GB&city=London&parameter=pm25&date_from=2025-11-01&limit=1000"
response <- GET(url_air, add_headers(Accept = "application/json"))
if (response$status_code != 200) {
stop("âŒ Failed to fetch air quality data. HTTP code: ", response$status_code)
}
